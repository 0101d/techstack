<!DOCTYPE html>
<html>
<head>
	<title>Nau Tech Stack</title>
	<style>
		html, body {
			padding: 0;
			margin: 0;
			box-sizing: border-box;
			font-family: Helvetica, Calibri, Roboto, Open Sans, sans-serif
		}
		* {
			box-sizing: inherit;
		}
		h1 {
			margin: auto;
			text-align: center;
		}
		svg {
			margin:auto;
			display:block;
		}

		.circle-overlay {
			border-radius: 50%;
			position: absolute;
			height: 350px;
			width: 350px;
			background-color: gray;
			overflow: hidden;
			display: none;
		}
		.circle-overlay__inner {
			text-align: center;
			width: 100%;
			height: 100%;
			padding: 10%;
		}
	</style>
</head>
<body>
	<h1>Nau Technologies Stack</h1>
	<svg width="100%" height="700" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>
	<div id="circle-overlay" class="circle-overlay">
		<div class="circle-overlay__inner">
			<h2 class="circle-overlay__title">ReactJS</h2>
			<p class="circle-overlay__body">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Ullam, sunt, aspernatur. Autem repudiandae, laboriosam. Nulla quidem nihil aperiam dolorem repellendus pariatur, quaerat sed eligendi inventore ipsa natus fugiat soluta doloremque!</p>
		</div>
	</div>

	<script src="js/d3.min.js"></script>
	<script>
		// Based loosely from this D3 bubble graph https://bl.ocks.org/mbostock/4063269
		// And this Forced directed diagram https://bl.ocks.org/mbostock/4062045
		let data = [{
			cat: 'library', name: 'D3', value: 30,
			icon: 'img/d3.svg',
		}, {
			cat: 'library', name: 'PostCSS', value: 30,
			icon: 'img/postcss.svg',
		}, {
			cat: 'library', name: 'Raphael', value: 10,
			icon: 'img/raphael.svg',
		}, {
			cat: 'library', name: 'Relay', value: 70,
			icon: 'img/relay.svg',
		}, {
			cat: 'library', name: 'Three.js', value: 40,
			icon: 'img/threejs.png',
		}, {
			cat: 'library.sub', name: 'Lodash', value: 30,
			icon: 'img/lodash.svg',
		}, {
			cat: 'library.sub', name: 'Moment JS', value: 30,
			icon: 'img/momentjs.png',
		}, {
			cat: 'library.sub', name: 'Numeral.js', value: 20,
			icon: 'Numeral.js',
		}, {
			cat: 'library.sub', name: 'Redux', value: 80,
			icon: 'img/redux.svg',
		}, {
			cat: 'framework', name: 'Angular 2.0', value: 30,
			icon: 'img/angular2.svg',
		}, /*{
			cat: 'framework', name: 'Trails.JS', value: 10,
			icon: '',
		},*/ {
			cat: 'framework', name: 'Bootstrap CSS', value: 50,
			icon: 'img/bootstrap.svg',
		}, {
			cat: 'framework', name: 'Ember JS', value: 10,
			icon: 'img/ember.png',
		}, {
			cat: 'framework', name: 'ExpressJS', value: 30,
			icon: 'img/expressjs.png',
		}, /*{
			cat: 'framework', name: 'Foundation', value: 10,
			icon: '',
		},*/{
			cat: 'framework', name: 'Hexo', value: 50,
			icon: 'img/hexo.png',
		}, {
			cat: 'framework', name: 'ReactJS', value: 100,
			icon: 'img/react.png',
			content: ``
		}, /*{
			cat: 'framework', name: 'SenchaTouch', value: 10,
			icon: '',
		},*/ {
			cat: 'tooling', name: 'Atom', value: 10,
			icon: 'img/atom.png',
		}, {
			cat: 'tooling', name: 'Google Chrome & Devtool', value: 70,
			icon: 'img/chrome-devtools.svg',
		}, {
			cat: 'tooling', name: 'Jenkins CI', value: 30,
			icon: 'img/jenkins.png',
		}, {
			cat: 'tooling', name: 'Sublime Text 3', value: 100,
			icon: 'img/sublimetext.png',
		}, {
			cat: 'tooling', name: 'Visual Studio Code', value: 50,
			icon: 'img/vscode.png',
		}, {
			cat: 'tooling', name: 'Web Page Performance Tooling', value: 30,
			icon: 'Web Page;Performance;Tooling',
		}, {
			cat: 'tooling', name: 'Yeoman generator for Nau Workflow', value: 20,
			icon: 'img/yeoman.png',
		}, {
			cat: 'backend', name: 'Elastic Search', value: 10,
			icon: 'Elastic;Search',
		}, {
			cat: 'backend', name: 'Keystone CMS', value: 50,
			icon: 'img/keystonejs.png',
		}, {
			cat: 'backend', name: 'KoaJS', value: 10,
			icon: 'img/koajs.png',
		}, {
			cat: 'backend', name: 'Loopback', value: 30,
			icon: 'img/loopback.svg',
		}, {
			cat: 'backend', name: 'Restify', value: 20,
			icon: 'img/restify.png',
		}, {
			cat: 'backend', name: 'MongoDB', value: 70,
			icon: 'img/mongodb.png',
		}, {
			cat: 'backend', name: 'NodeJS', value: 100,
			icon: 'img/nodejs.svg',
		}, {
			cat: 'platform', name: 'Docker Platform', value: 10,
			icon: 'img/docker.svg',
		}, {
			cat: 'platform', name: 'MeteorJS', value: 80,
			icon: 'img/meteor.svg',
		}, {
			cat: 'platform', name: 'Reaction Commerce', value: 20,
			icon: 'img/reactioncommerce.png',
		}, {
			cat: 'platform', name: 'ReactNative', value: 10,
			icon: 'img/reactnative.png',
		}, {
			cat: 'platform', name: 'SquareSpace', value: 30,
			icon: 'img/squarespace.svg',
		}, {
			cat: 'language', name: 'HTML5 & CSS3', value: 100,
			icon: 'img/html5-css3.png',
		}, {
			cat: 'language', name: 'JavaScript', value: 100,
			icon: 'img/javascript.png',
		}, {
			cat: 'language', name: 'CSS Next', value: 10,
			icon: 'img/cssnext.png',
		}, {
			cat: 'language', name: 'GraphQL', value: 50,
			icon: 'img/graphql.svg',
		}, {
			cat: 'language', name: 'LESS CSS', value: 20,
			icon: 'img/less.svg',
		}, {
			cat: 'language', name: 'SCSS (Sass)', value: 70,
			icon: 'img/sass.png',
		}, {
			cat: 'language', name: 'TypeScript 2', value: 30,
			icon: 'img/typescript.png',
		}, {
			cat: 'workflow', name: 'code.naustud.io', value: 100,
			icon: 'img/naustudio.svg',
		}, {
			cat: 'workflow', name: 'BabelJS', value: 50,
			icon: 'img/babel.png',
		}, /*{
			cat: 'workflow', name: 'Browserify', value: 10,
			icon: '',
		},*/ {
			cat: 'workflow', name: 'CSS BEM Notation', value: 70,
			icon: 'CSS BEM Notation',
		}, {
			cat: 'workflow', name: 'Front End Code Guide', value: 30,
			icon: 'Front End;Code Guide',
		}, {
			cat: 'workflow', name: 'ESLint', value: 20,
			icon: 'img/eslint.svg',
		}, {
			cat: 'workflow', name: 'Gitflow Workflow', value: 70,
			icon: 'img/gitflow.png',
		}, {
			cat: 'workflow', name: 'GulpJS', value: 50,
			icon: 'img/gulp.png',
		}, {
			cat: 'workflow', name: 'Nau Code Styles', value: 50,
			icon: 'Nau Code Styles',
		}, {
			cat: 'workflow', name: 'Stylelint', value: 50,
			icon: 'img/stylelint.svg',
		}, {
			cat: 'workflow', name: 'SystemJS', value: 20,
			icon: 'SystemJS',
		}, {
			cat: 'workflow', name: 'Webpack', value: 30,
			icon: 'img/webpack.svg',
		}, {
			cat: 'deprecated', name: 'AngularJS 1', value: 10,
			icon: 'img/angular1.png',
		}, {
			cat: 'deprecated', name: 'Backbone', value: 30,
			icon: 'img/backbone.png',
		}, {
			cat: 'deprecated', name: 'Grunt & Automation Stack', value: 30,
			icon: 'img/grunt.svg',
		}, {
			cat: 'deprecated', name: 'jQuery', value: 50,
			icon: 'img/jquery.png',
		}, {
			cat: 'deprecated', name: 'RequireJS & AMD', value: 30,
			icon: 'img/requirejs.svg',
		}, {
			cat: 'deprecated.tooling', name: 'Browser Sync', value: 40,
			icon: 'Browser Sync',
		}, {
			cat: 'deprecated.tooling', name: 'Git Pre-commit', value: 30,
			icon: 'Git;Pre-commit',
		}, {
			cat: 'deprecated.tooling', name: 'http-server', value: 20,
			icon: 'http-server',
		}, {
			cat: 'deprecated.tooling', name: 'LiveReload', value: 20,
			icon: 'Live;Reload',
		}, {
			cat: 'deprecated.tooling', name: 'live-server', value: 30,
			icon: 'live-server',
		}];
	</script>

	<script>
		let svg = d3.select('svg');
		let circleOverlay = d3.select('#circle-overlay');
		let width = document.body.clientWidth; // get width in pixels
		let height = +svg.attr('height');
		let centerX = width * 0.5;
		let centerY = height * 0.5;
		let strength = 0.05;
		let focusedNode;

		let format = d3.format(',d');

		let scaleColor = d3.scaleOrdinal(d3.schemeCategory20);

		// use pack to calculate radius of the circle
		let pack = d3.pack()
			.size([width , height ])
			.padding(1.5);

		let forceCollide = d3.forceCollide(d => d.r + 1);

		// use the force
		let simulation = d3.forceSimulation()
			// .force('link', d3.forceLink().id(d => d.id))
			.force('charge', d3.forceManyBody())
			.force('collide', forceCollide)
			// .force('center', d3.forceCenter(centerX, centerY))
			.force('x', d3.forceX(centerX ).strength(strength))
			.force('y', d3.forceY(centerY ).strength(strength));

		// reduce number of circles on mobile screen due to slow computation
		if ('matchMedia' in window && window.matchMedia('(max-device-width: 767px)').matches) {
			data = data.filter(el => {
				return el.value >= 50;
			});
		}

		let root = d3.hierarchy({ children: data })
			.sum(d => d.value);

		// we use pack() to automatically calculate radius conveniently only
		// and get only the leaves
		let nodes = pack(root).leaves().map(node => {
			console.log('node:', node.x, (node.x - centerX) * 2);
			const data = node.data;
			return {
				x: centerX + (node.x - centerX) * 3, // magnify start position to have transition to center movement
				y: centerY + (node.y - centerY) * 3,
				r: 0, // for tweening
				radius: node.r, //original radius
				id: data.cat + '.' + (data.name.replace(/\s/g, '-')),
				cat: data.cat,
				name: data.name,
				value: data.value,
				icon: data.icon,
			}
		});
		simulation.nodes(nodes).on('tick', ticked);

		svg.style('background-color', '#eee');
		let node = svg.selectAll('.node')
			.data(nodes)
			.enter().append('g')
			.attr('class', 'node')
			.call(d3.drag()
				.on('start', (d) => {
					if (!d3.event.active) simulation.alphaTarget(0.2).restart();
					d.fx = d.x;
					d.fy = d.y;
				})
				.on('drag', (d) => {
					d.fx = d3.event.x;
					d.fy = d3.event.y;
				})
				.on('end', (d) => {
					if (!d3.event.active) simulation.alphaTarget(0);
					d.fx = null;
					d.fy = null;
				}));

		node.append('circle')
			.attr('id', d => d.id)
			.attr('r', 0)
			.style('fill', d => scaleColor(d.cat))
			.transition().duration(2000).ease(d3.easeElasticOut)
				.tween('circleIn', (d) => {
					let i = d3.interpolateNumber(0, d.radius);
					return (t) => {
						d.r = i(t);
						simulation.force('collide', forceCollide);
					}
				})

		node.append('clipPath')
			.attr('id', d => `clip-${d.id}`)
			.append('use')
			.attr('xlink:href', d => `#${d.id}`);

		// display text as circle icon
		node.filter(d => !String(d.icon).includes('img/'))
			.append('text')
			.attr('clip-path', d => `url(#clip-${d.id})`)
			.selectAll('tspan')
			.data(d => d.icon.split(';'))
			.enter()
				.append('tspan')
				.attr('x', 0)
				.attr('y', (d, i, nodes) => (13 + (i - nodes.length / 2 - 0.5) * 10))
				.text(name => name);

		// display image as circle icon
		node.filter(d => String(d.icon).includes('img/'))
			.append('image')
			.attr('clip-path', d => `url(#clip-${d.id})`)
			.attr('xlink:href', d => d.icon)
			.attr('x', d => - d.radius * 0.7)
			.attr('y', d => - d.radius * 0.7)
			.attr('height', d => d.radius * 2 * 0.7)
			.attr('width', d => d.radius * 2 * 0.7)

		node.append('title')
			.text(d => (d.cat + '::' + d.name + '\n' + format(d.value)));

		node.on('click', (currentNode) => {
			d3.event.stopPropagation();
			console.log('currentNode', currentNode);
			let currentTarget = d3.event.currentTarget; // the <g> el

			if (currentNode === focusedNode) {
				// no focusedNode or same focused node is clicked
				return;
			}
			let lastNode = focusedNode;
			focusedNode = currentNode;

			simulation.alphaTarget(0.2).restart();
			circleOverlay.style('display', 'none');

			// don't fix last node to center anymore
			if (lastNode) {
				lastNode.fx = null;
				lastNode.fy = null;
				node.filter((d, i) => i === lastNode.index)
					.transition().duration(2000).ease(d3.easePolyOut)
					.tween('circleOut', () => {
						let irl = d3.interpolateNumber(lastNode.r, lastNode.radius);
						return (t) => {
							lastNode.r = irl(t);
						}
					})
					.on('interrupt', () => {
						lastNode.r = lastNode.radius;
					});
			}

			// if (!d3.event.active) simulation.alphaTarget(0.5).restart();

			d3.transition().duration(2000).ease(d3.easePolyOut)
				.tween('moveIn', () => {
					console.log('tweenMoveIn', currentNode);
					let ix = d3.interpolateNumber(currentNode.x, centerX);
					let iy = d3.interpolateNumber(currentNode.y, centerY);
					let ir = d3.interpolateNumber(currentNode.r, centerY * 0.5);
					return function (t) {
						// console.log('i', ix(t), iy(t));
						currentNode.fx = ix(t);
						currentNode.fy = iy(t);
						currentNode.r = ir(t);
						simulation.force('collide', forceCollide);
					};
				})
				.on('end', () => {
					simulation.alphaTarget(0);
					//
					const circle = currentTarget.querySelector('circle');
					const rect = circle.getClientRects()[0];
					const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
					console.log('rect', rect);
					circleOverlay.style('top', rect.top + scrollTop + 'px')
						.style('left', rect.left + 'px')
						.style('display', 'block')
						.style('background-color', d3.select(circle).style('fill'))
					circleOverlay.select('.circle-overlay__title').text(currentNode.name);
					circleOverlay.select('.circle-overlay__body').html(currentNode.name);
				})
				.on('interrupt', () => {
					console.log('move interrupt', currentNode);
					currentNode.fx = null;
					currentNode.fy = null;
					simulation.alphaTarget(0);
				});

		});

		// blur
		d3.select(document).on('click', () => {
			let target = d3.event.target;
			// check if click on document but not on the circle overlay
			if (!target.closest('#circle-overlay') && focusedNode) {
				focusedNode.fx = null;
				focusedNode.fy = null;
				simulation.alphaTarget(0.2).restart();
				d3.transition().duration(2000).ease(d3.easePolyOut)
					.tween('moveOut', function () {
						console.log('tweenMoveOut', focusedNode);
						let ir = d3.interpolateNumber(focusedNode.r, focusedNode.radius);
						return function (t) {
							focusedNode.r = ir(t);
							simulation.force('collide', forceCollide);
						};
					})
					.on('end', () => {
						focusedNode = null;
						simulation.alphaTarget(0);
					})
					.on('interrupt', () => {
						simulation.alphaTarget(0);
					});
				circleOverlay.style('display', 'none');
			}
		});

		function ticked() {
			// link
			// 	.attr('x1', function(d) { return d.source.x; })
			// 	.attr('y1', function(d) { return d.source.y; })
			// 	.attr('x2', function(d) { return d.target.x; })
			// 	.attr('y2', function(d) { return d.target.y; });
			node
				.attr('transform', d => `translate(${d.x},${d.y})`)
				.select('circle')
					.attr('r', d => d.r);
		}
	</script>
</body>
</html>
